
{% for option_form in form.cartItem.variant.productOptions %}
    {{ form_row(option_form, { 'attr': {
        'data-option-id': option_form.vars.id
    } }) }}
{% endfor %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dependencies = {{ dependencies | json_encode | raw }};

            const dependenciesMap = {};

            dependencies.forEach(dep => {
                const parentOptionId = dep.parentOption.id;
                const parentOptionValueId = dep.parentOptionValue.id;
                const childOptionId = dep.childOption.id;

                if (!dependenciesMap[parentOptionId]) {
                    dependenciesMap[parentOptionId] = {};
                }

                if (!dependenciesMap[parentOptionId][parentOptionValueId]) {
                    dependenciesMap[parentOptionId][parentOptionValueId] = [];
                }

                dependenciesMap[parentOptionId][parentOptionValueId].push(childOptionId);
            });

            function updateOptionsDisplay() {
                Object.keys(dependenciesMap).forEach(parentOptionId => {
                    const parentSelect = document.querySelector(`[data-option-id="${parentOptionId}"] select`);
                    if (parentSelect) {
                        const selectedValue = parentSelect.value;

                        const childOptions = dependenciesMap[parentOptionId][selectedValue] || [];

                        childOptions.forEach(childOptionId => {
                            const childOptionDiv = document.querySelector(`[data-option-id="${childOptionId}"]`);
                            if (childOptionDiv) {
                                childOptionDiv.style.display = 'block';
                            }
                        });

                        // Masquer les autres options enfants
                        Object.values(dependenciesMap[parentOptionId]).forEach(valueDependentOptions => {
                            valueDependentOptions.forEach(childOptionId => {
                                if (!childOptions.includes(childOptionId)) {
                                    const childOptionDiv = document.querySelector(`[data-option-id="${childOptionId}"]`);
                                    if (childOptionDiv) {
                                        childOptionDiv.style.display = 'none';
                                    }
                                }
                            });
                        });
                    }
                });
            }

            // Ajouter des écouteurs d'événements sur les options parents
            Object.keys(dependenciesMap).forEach(parentOptionId => {
                const parentSelect = document.querySelector(`[data-option-id="${parentOptionId}"] select`);
                if (parentSelect) {
                    parentSelect.addEventListener('change', updateOptionsDisplay);
                }
            });

            // Initialiser l'affichage des options
            updateOptionsDisplay();
        });
    </script>
{% endblock %}
